name: Update Profile README

on:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours
  workflow_dispatch: # Allows manual trigger

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests
        run: pip install requests

      - name: Update Latest Project
        run: |
          import requests
          import re
          import os

          USERNAME = "0xsaksham"
          README_PATH = "README.md"

          # 1. Fetch latest events
          url = f"https://api.github.com/users/{USERNAME}/events/public"
          r = requests.get(url)
          events = r.json()

          latest_repo_name = "expense-tracker" # Fallback
          latest_repo_url = "https://github.com/0xSaksham/expense-tracker"

          # 2. Find the last PushEvent
          for event in events:
              if event["type"] == "PushEvent":
                  latest_repo_name = event["repo"]["name"].split("/")[-1] # remove username/
                  latest_repo_url = f"https://github.com/{event['repo']['name']}"
                  break

          print(f"Latest project found: {latest_repo_name}")

          # 3. Read README
          with open(README_PATH, "r", encoding="utf-8") as file:
              content = file.read()

          # 4. Replace content between markers
          new_line = f"- ðŸš€  I'm currently working on [{latest_repo_name}]({latest_repo_url})"

          pattern = r"(<!-- LATEST_PROJECT_START -->)([\s\S]*?)(<!-- LATEST_PROJECT_END -->)"
          replacement = f"\\1\n{new_line}\n\\3"

          new_content = re.sub(pattern, replacement, content)

          # 5. Write back
          with open(README_PATH, "w", encoding="utf-8") as file:
              file.write(new_content)
        shell: python

      - name: Commit and Push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "docs: update latest project" && git push)

  update-wakatime:
    needs: update-project
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Update WakaTime Stats
        uses: athul/waka-readme@master
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          SHOW_TITLE: true
          SECTION_NAME: wakatime
          BLOCKS: â£€â£„â£¤â£¦â£¶â£·
          CODE_LANG: java
          TIME_RANGE: last_7_days
          LANG_COUNT: 5
          SHOW_TIME: true 
